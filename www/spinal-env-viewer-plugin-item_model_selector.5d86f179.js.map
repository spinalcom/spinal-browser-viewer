{"mappings":"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","sources":["node_modules/spinal-env-viewer-plugin-item_model_selector/index.js","node_modules/spinal-env-viewer-plugin-item_model_selector/src/index.js","node_modules/spinal-env-viewer-context-menu-service/index.js","node_modules/spinal-env-viewer-context-menu-service/SpinalContextMenuService.js","node_modules/spinal-env-viewer-context-menu-service/SpinalContextApp.js","node_modules/spinal-env-viewer-context-menu-service/constants.js","node_modules/spinal-env-viewer-plugin-item_model_selector/src/btn/UpdateBimObjectIdBtn.js"],"sourcesContent":["/*\n * Copyright 2020 SpinalCom - www.spinalcom.com\n *\n * This file is part of SpinalCore.\n *\n * Please read all of the following terms and conditions\n * of the Free Software license Agreement (\"Agreement\")\n * carefully.\n *\n * This Agreement is a legally binding contract between\n * the Licensee (as defined below) and SpinalCom that\n * sets forth the terms and conditions that govern your\n * use of the Program. By installing and/or using the\n * Program, you agree to abide by all the terms and\n * conditions stated or referenced herein.\n *\n * If you do not agree to abide by these terms and\n * conditions, do not demonstrate your acceptance and do\n * not install or use the Program.\n * You should have received a copy of the license along\n * with this file. If not, see\n * <http://resources.spinalcom.com/licenses.pdf>.\n */\n\nrequire(\"./src/index\");\n","/*\n * Copyright 2020 SpinalCom - www.spinalcom.com\n *\n * This file is part of SpinalCore.\n *\n * Please read all of the following terms and conditions\n * of the Free Software license Agreement (\"Agreement\")\n * carefully.\n *\n * This Agreement is a legally binding contract between\n * the Licensee (as defined below) and SpinalCom that\n * sets forth the terms and conditions that govern your\n * use of the Program. By installing and/or using the\n * Program, you agree to abide by all the terms and\n * conditions stated or referenced herein.\n *\n * If you do not agree to abide by these terms and\n * conditions, do not demonstrate your acceptance and do\n * not install or use the Program.\n * You should have received a copy of the license along\n * with this file. If not, see\n * <http://resources.spinalcom.com/licenses.pdf>.\n */\n\nimport { spinalContextMenuService } from \"spinal-env-viewer-context-menu-service\";\nimport { UpdateBimObjectIdBtn } from \"./btn/UpdateBimObjectIdBtn\";\n\nconst SIDE_BAR_HOOK_NAME = \"GraphManagerSideBar\";\nspinalContextMenuService.registerApp(SIDE_BAR_HOOK_NAME, new UpdateBimObjectIdBtn(), [7]);\n","/*\n * Copyright 2018 SpinalCom - www.spinalcom.com\n *\n * This file is part of SpinalCore.\n *\n * Please read all of the following terms and conditions\n * of the Free Software license Agreement (\"Agreement\")\n * carefully.\n *\n * This Agreement is a legally binding contract between\n * the Licensee (as defined below) and SpinalCom that\n * sets forth the terms and conditions that govern your\n * use of the Program. By installing and/or using the\n * Program, you agree to abide by all the terms and\n * conditions stated or referenced herein.\n *\n * If you do not agree to abide by these terms and\n * conditions, do not demonstrate your acceptance and do\n * not install or use the Program.\n * You should have received a copy of the license along\n * with this file. If not, see\n * <http://resources.spinalcom.com/licenses.pdf>.\n */\n\nconst G_root = typeof window == \"undefined\" ? global : window;\nconst SpinalContextMenuService = require(\"./SpinalContextMenuService\");\nconst SpinalContextApp = require(\"./SpinalContextApp\");\nconst Constant = require('./constants');\nif (typeof G_root.spinal === \"undefined\") G_root.spinal = {};\nif (typeof G_root.spinal.spinalContextMenuService === \"undefined\")\n  G_root.spinal.spinalContextMenuService = new SpinalContextMenuService();\n\nmodule.exports = {\n  constants: Constant,\n  spinalContextMenuService: G_root.spinal.spinalContextMenuService,\n  SpinalContextApp,\n  install(Vue) {\n    Vue.prototype.$spinalContextMenuService =\n      G_root.spinal.spinalContextMenuService;\n  }\n};\n","/*\n * Copyright 2018 SpinalCom - www.spinalcom.com\n *\n * This file is part of SpinalCore.\n *\n * Please read all of the following terms and conditions\n * of the Free Software license Agreement (\"Agreement\")\n * carefully.\n *\n * This Agreement is a legally binding contract between\n * the Licensee (as defined below) and SpinalCom that\n * sets forth the terms and conditions that govern your\n * use of the Program. By installing and/or using the\n * Program, you agree to abide by all the terms and\n * conditions stated or referenced herein.\n *\n * If you do not agree to abide by these terms and\n * conditions, do not demonstrate your acceptance and do\n * not install or use the Program.\n * You should have received a copy of the license along\n * with this file. If not, see\n * <http://resources.spinalcom.com/licenses.pdf>.\n */\n\nimport * as Q from 'q';\nvar debounce = require('lodash.debounce');\n\n/**\n *  Containter like service to register and get applications relative to a hookname\n *\n * @property {object} apps key = hookname, value array of apps\n * @class SpinalContextMenuService\n */\nclass SpinalContextMenuService {\n  /**\n   *Creates an instance of SpinalContextMenuService.\n   * @memberof SpinalContextMenuService\n   */\n  constructor() {\n    this.apps = {};\n    this.promiseByAppProfileId = {};\n    this.appRdy = Q.defer();\n    this.debouncedRdy = debounce(\n      () => {\n        this.appRdy.resolve();\n        this.debouncedRdy = () => {};\n      },\n      1000,\n      { leading: false, trailing: true }\n    );\n  }\n\n  // waitRdy() {\n  //   this.appRdy.promise;\n  // }\n\n  /**\n   * Return true if user has access to this appProfile\n   * @param appProfileId\n   * @return {PromiseLike<boolean > | Promise<boolean>}\n   */\n  async hasUserRight(appProfileId) {\n    this.debouncedRdy();\n    await window.spinal.spinalSystem.init();\n    const path =\n      '/etc/UserProfileDir/' + window.spinal.spinalSystem.getUser().username;\n    const userProfile = await window.spinal.spinalSystem.load(path);\n    let res = false;\n    if (userProfile) {\n      for (let i = 0; i < userProfile.appProfiles.length && !res; i++) {\n        res = ((1 << userProfile.appProfiles[i]) & appProfileId) !== 0;\n      }\n    }\n    return res;\n  }\n\n  /**\n   * method to register the Application to a hook\n   *\n   * @param {string} hookname the place where is application button is located\n   * @param {SpinalContextApp} spinalContextApp the application\n   * @param {number} appProfileId id of the group that can use the application\n   * button\n   * @memberof SpinalContextMenuService\n   */\n  registerApp(hookname, spinalContextApp, appProfileId) {\n    this.debouncedRdy();\n    if (typeof appProfileId === 'undefined') {\n      console.warn(\n        'Deprecated: The usage of this function without the third' +\n          ' parameter appProfileId is deprecated your button is lock for admin' +\n          ' only until you set the third parameter'\n      );\n      appProfileId = 1;\n    }\n    // get the array of apps of the hook\n    let appsInHooks = this.apps[hookname];\n\n    // create the array if not exist\n    if (!(appsInHooks instanceof Array)) {\n      appsInHooks = this.apps[hookname] = [];\n    }\n\n    if (!this.promiseByAppProfileId.hasOwnProperty(appProfileId)) {\n      this.promiseByAppProfileId[appProfileId] =\n        this.hasUserRight(appProfileId);\n    }\n\n    this.promiseByAppProfileId[appProfileId].then((hasAccess) => {\n      // push the app if not exist ans user has access to the button\n      if (hasAccess && appsInHooks.indexOf(spinalContextApp) === -1) {\n        appsInHooks.push(spinalContextApp);\n      }\n    });\n  }\n\n  /**\n   * method to get the applications registered to a hookname\n   *\n   * @param {String} hookname\n   * @param {object} option\n   * @memberof SpinalContextMenuService\n   * @returns {Promise} resolve : [spinalContextApp, ...]; reject: Error\n   */\n  async getApps(hookname, option) {\n    await this.appRdy.promise;\n    // get the array of apps of the hook\n    let appsInHooks = this.apps[hookname];\n\n    // create the array if not exist\n    if (!(appsInHooks instanceof Array)) {\n      return Promise.resolve([]);\n    }\n    let promises = appsInHooks.map(async function (e, idx) {\n      try {\n        const res = await e.isShown(option);\n        return res === -1 ? -1 : e;\n      } catch (error) {\n        console.error(error);\n        return -1;\n      }\n    });\n    try {\n      const appRes = await Promise.all(promises);\n      return appRes.filter((itm) => itm !== -1);\n    } catch (error) {\n      console.error(error);\n      return [];\n    }\n  }\n}\n\nmodule.exports = SpinalContextMenuService;\n","/*\n * Copyright 2018 SpinalCom - www.spinalcom.com\n *\n * This file is part of SpinalCore.\n *\n * Please read all of the following terms and conditions\n * of the Free Software license Agreement (\"Agreement\")\n * carefully.\n *\n * This Agreement is a legally binding contract between\n * the Licensee (as defined below) and SpinalCom that\n * sets forth the terms and conditions that govern your\n * use of the Program. By installing and/or using the\n * Program, you agree to abide by all the terms and\n * conditions stated or referenced herein.\n *\n * If you do not agree to abide by these terms and\n * conditions, do not demonstrate your acceptance and do\n * not install or use the Program.\n * You should have received a copy of the license along\n * with this file. If not, see\n * <http://resources.spinalcom.com/licenses.pdf>.\n */\n\n/**\n *  Interface like class to define a Contextual Application button\n * @see https://material.io/tools/icons/?style=baseline for material icons\n *\n * @class SpinalContextApp\n * @property {string} label=notset short name to be shown in the application\n * @property {string} description description of what the Application button do\n * @property {object} buttonCfg Object configuration of the Application button\n * @property {string} buttonCfg.icon=tab can be a font-awsome or material icon string\n * @property {string} buttonCfg.icon_type=in Where to place the icon in the `md-icon`. Should be one of theses `class`, `in`, `src`\n * @property {string} buttonCfg.backgroundColor=#0000FF backgroud color of the button\n * @property {string} buttonCfg.fontColor=#FFFFFF font color of the button\n * @property {objet} [badgeCfg] Object configuration of the Application button badge\n * @property {string} badgeCfg.label string shown in a badge; if empty it's not shown\n * @property {string} badgeCfg.backgroundColor=#FF0000 backgroud color of the badge\n * @property {string} badgeCfg.fontColor=#FFFFFF font color of the badge\n */\nclass SpinalContextApp {\n  /**\n   * Creates an instance of SpinalContextApp.\n   * @param {string} label=notset short name to be shown in the application\n   * @param {string} description description of what the Application button do\n   * @param {object} buttonCfg Object configuration of the Application button\n   * @param {string} buttonCfg.icon=tab can be a font-awsome or material icon string\n   * @param {string} buttonCfg.icon_type=in Where to place the icon in the `md-icon`. Should be one of theses `class`, `in`, `src`\n   * @param {string} buttonCfg.backgroundColor=#0000FF backgroud color of the button\n   * @param {string} buttonCfg.fontColor=#FFFFFF font color of the button\n   * @param {objet} [badgeCfg] Object configuration of the Application button badge\n   * @param {string} badgeCfg.label string shown in a badge; if empty it's not shown\n   * @param {string} badgeCfg.backgroundColor=#FF0000 backgroud color of the badge\n   * @param {string} badgeCfg.fontColor=#FFFFFF font color of the badge\n   * @memberof SpinalContextApp\n   */\n  constructor(label, description, buttonCfg, badgeCfg = {}) {\n    this.label = label || \"notset\";\n    this.description = description || \"\";\n    this.buttonCfg = {\n      icon: buttonCfg.icon || \"tab\",\n      icon_type: buttonCfg.icon_type || \"in\",\n      backgroundColor: colorHash(buttonCfg.backgroundColor || \"#0000FF\"),\n      fontColor: colorHash(buttonCfg.fontColor || \"#FFFFFF\")\n    };\n\n    this.badgeCfg = {\n      label: badgeCfg.label || \"\",\n      backgroundColor: colorHash(badgeCfg.backgroundColor || \"#FF0000\"),\n      fontColor: colorHash(badgeCfg.fontColor || \"#FFFFFF\")\n    };\n  }\n\n  /**\n   * Method called by `SpinalContextMenuService.getApps`\n   * to filter the Application button to show in the context hook\n   *\n   * @param {object} option\n   * @memberof SpinalContextApp\n   * @returns {Promise} Resolve: not shown if === -1;\n   */\n  isShown(option) {}\n\n  /**\n   * Method to call on click of the application button\n   *\n   * @param {object} option {}\n   * @memberof SpinalContextApp\n   */\n  action(option) {}\n}\n\nmodule.exports = SpinalContextApp;\n\nfunction colorHash(color) {\n  if (color[0] === \"#\") return color;\n  return \"#\" + color;\n}\n","\n\nmodule.exports = {\n  ADMINISTRATEUR: 'ADMINISTRATEUR',\n  MAINTENEUR: 'MAINTENEUR',\n  INTEGRATEUR: 'INTEGRATEUR',\n  ASSET_MANAGEUR: 'ASSET MANAGER',\n};","/*\n * Copyright 2020 SpinalCom - www.spinalcom.com\n *\n * This file is part of SpinalCore.\n *\n * Please read all of the following terms and conditions\n * of the Free Software license Agreement (\"Agreement\")\n * carefully.\n *\n * This Agreement is a legally binding contract between\n * the Licensee (as defined below) and SpinalCom that\n * sets forth the terms and conditions that govern your\n * use of the Program. By installing and/or using the\n * Program, you agree to abide by all the terms and\n * conditions stated or referenced herein.\n *\n * If you do not agree to abide by these terms and\n * conditions, do not demonstrate your acceptance and do\n * not install or use the Program.\n * You should have received a copy of the license along\n * with this file. If not, see\n * <http://resources.spinalcom.com/licenses.pdf>.\n */\n\nimport { SpinalContextApp } from 'spinal-env-viewer-context-menu-service';\nimport { SpinalGraphService } from 'spinal-env-viewer-graph-service';\n\nconst LABEL = 'Update BimObject Ids';\nconst NODE_TYPE = 'BimFile';\n\nasync function updateBimObjectId(bimObjects) {\n  const mapModelExternId = new Map();\n  const updated = [];\n\n  function getExternalIdMapping(model) {\n    if (mapModelExternId.has(model)) return mapModelExternId.get(model);\n    const prom = new Promise((resolve) => {\n      model.getExternalIdMapping((map) => {\n        resolve(map);\n      });\n    });\n    mapModelExternId.set(model, prom);\n    return prom;\n  }\n\n  console.log(\"updateBimObjectId - number of items :\", bimObjects.length);\n  for (const bimObj of bimObjects) {\n    const bimFileId = bimObj.info.bimFileId.get();\n    const model = window.spinal.BimObjectService.getModelByBimfile(bimFileId);\n    // eslint-disable-next-line no-await-in-loop\n    const externalIdMapping = await getExternalIdMapping(model);\n    const externalId = bimObj.info.externalId.get();\n    if (bimObj.info.dbid.get() !== externalIdMapping[externalId]) {\n      updated.push(externalIdMapping[externalId]);\n      bimObj.info.dbid.set(externalIdMapping[externalId]);\n    }\n  }\n  console.log(\"End\");\n  if (updated.length > 0) console.log('UPDATED', updated);\n}\n\nexport class UpdateBimObjectIdBtn extends SpinalContextApp {\n\n  constructor() {\n    super(LABEL, LABEL, {\n      icon: 'clear_all',\n      icon_type: 'in',\n      backgroundColor: '#000000',\n      fontColor: '#ffffff'\n    });\n  }\n\n  isShown(option) {\n    if (option.selectedNode.type.get() === NODE_TYPE) {\n      return Promise.resolve(true);\n    }\n    return Promise.resolve(-1);\n  }\n\n  async action(option) {\n    const nodeId = option.selectedNode.id.get();\n    const rNode = SpinalGraphService.getRealNode(nodeId);\n    const bimObjects = [];\n    const bimContexts = await rNode.getChildren(\"hasBimContext\");\n    for (const bimContext of bimContexts) {\n      // eslint-disable-next-line no-await-in-loop\n      const bimObj = await bimContext.getChildren(\"hasBimObject\");\n      bimObjects.push(...bimObj);\n    }\n    return updateBimObjectId(bimObjects);\n  }\n}\n"],"names":[],"version":3,"file":"spinal-env-viewer-plugin-item_model_selector.5d86f179.js.map"}