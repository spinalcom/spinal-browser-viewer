{"mappings":";;;;A;;;;A;;;;;;A;;;;A;;;;;;A;;;;;;;;;;A;;;;;;A;;;;;;A;;;;;A;;;;;;;;;A;;;;A;;;;;A","sources":["node_modules/spinal-env-viewer-plugin-scene/src/vue/DialogCreateScene.vue","node_modules/spinal-env-viewer-plugin-scene/src/vue/SelectAttribute.vue","node_modules/spinal-env-viewer-plugin-scene/src/vue/PanelSceneManager.vue"],"sourcesContent":["\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","<!--\nCopyright 2021 SpinalCom - www.spinalcom.com\n\nThis file is part of SpinalCore.\n\nPlease read all of the following terms and conditions\nof the Free Software license Agreement (\"Agreement\")\ncarefully.\n\nThis Agreement is a legally binding contract between\nthe Licensee (as defined below) and SpinalCom that\nsets forth the terms and conditions that govern your\nuse of the Program. By installing and/or using the\nProgram, you agree to abide by all the terms and\nconditions stated or referenced herein.\n\nIf you do not agree to abide by these terms and\nconditions, do not demonstrate your acceptance and do\nnot install or use the Program.\nYou should have received a copy of the license along\nwith this file. If not, see\n<http://resources.spinalcom.com/licenses.pdf>.\n-->\n\n<template>\n  <v-app class=\"scene-manager\" dark>\n    <v-stepper vertical dark v-model=\"step\">\n      <v-stepper-step editable :complete=\"step > 1\" step=\"1\">\n        Select models\n      </v-stepper-step>\n      <v-stepper-content step=\"1\" id=\"step1\">\n        <v-select\n          v-model=\"selectedModels\"\n          :items=\"bimFilesComputed\"\n          label=\"Models\"\n          multiple\n          hint=\"Choose the model to add to the scene\"\n          persistent-hint\n          :attach=\"container\"\n        >\n        </v-select>\n      </v-stepper-content>\n      <v-stepper-step editable :complete=\"step > 2\" step=\"2\">\n        Choose referential\n      </v-stepper-step>\n      <v-stepper-content step=\"2\" id=\"step2\">\n        <v-select\n          v-model=\"loadOptionSelected\"\n          :items=\"loadOptions\"\n          item-text=\"name\"\n          item-value=\"value\"\n          label=\"Load scene option\"\n          hint=\"select the Load type for this scene\"\n          persistent-hint\n          :attach=\"container\"\n        >\n        </v-select>\n        <v-checkbox\n          v-model=\"useAllModels\"\n          label=\"Use whole digital twin\"\n        ></v-checkbox>\n\n        <!-- \n        <v-checkbox\n          v-model=\"autoPosition\"\n          label=\"Use models inner position\"\n        ></v-checkbox> -->\n        <div v-if=\"!useAllModels\">\n          <v-layout align-center justify-space-around row>\n            <v-flex>\n              <v-btn flat icon @click=\"getSelection\">\n                <v-icon>add</v-icon>\n              </v-btn>\n            </v-flex>\n            <v-flex>\n              <v-btn flat icon @click=\"clearSelection\">\n                <v-icon>close</v-icon>\n              </v-btn>\n            </v-flex>\n            <v-flex>\n              <v-btn flat icon @click=\"selectOBJ\">\n                <v-icon>visibility</v-icon>\n              </v-btn>\n            </v-flex>\n          </v-layout>\n          <div v-if=\"displayNeedToLoadModel\">\n            Models need to be loaded to see the selection\n            <v-btn flat icon @click=\"loadAllModel\">\n              <v-icon>get_app</v-icon>\n            </v-btn>\n          </div>\n          {{ objectSelectedSentence }}\n        </div>\n      </v-stepper-content>\n\n      <v-stepper-step editable :complete=\"step > 2\" step=\"3\">\n        Edit scene\n      </v-stepper-step>\n      <v-stepper-content step=\"3\" id=\"step3\">\n        <v-checkbox\n          v-model=\"autoLoad\"\n          label=\"load the scene automatically\"\n        ></v-checkbox>\n        <v-text-field\n          v-model=\"sceneName\"\n          label=\"Name\"\n          :placeholder=\"name\"\n        ></v-text-field>\n        <v-text-field\n          v-model=\"sceneDescr\"\n          label=\"Description\"\n          :placeholder=\"description\"\n        ></v-text-field>\n      </v-stepper-content>\n\n      <v-stepper-step editable step=\"4\"> Summary </v-stepper-step>\n      <v-stepper-content step=\"4\" id=\"step4\">\n        {{ nbModel }} model include in this scene\n        <div v-for=\"model in selectedModelInfo\">\n          {{ model.name }} with {{ getDbIdLength() }} object selected\n          <v-btn\n            v-if=\"typeof model.dbIds !== 'undefined' && getDbIdLength() > 0\"\n            flat\n            icon\n            @click=\"selectOBJ\"\n          >\n            <v-icon>visibility</v-icon>\n          </v-btn>\n        </div>\n        <v-btn flat @click=\"save\"> Save </v-btn>\n      </v-stepper-content>\n    </v-stepper>\n  </v-app>\n</template>\n\n<script>\nimport { SceneHelper } from \"../build/SceneHelper\";\nimport { SpinalGraphService } from \"spinal-env-viewer-graph-service\";\nimport { filterDbid, getAttributeName } from \"./ForgeWorkerFunctions\";\nimport SelectAttribute from \"./SelectAttribute.vue\";\nimport { PART_RELATION_NAME, PART_RELATION_TYPE } from \"../constants\";\n\nexport default {\n  name: \"PanelSceneManager\",\n  components: { SelectAttribute },\n  data: function () {\n    return {\n      step1Container: null,\n      step2Container: null,\n      step3Container: null,\n      // autoPosition: false,\n\n      loadOptionSelected: 0,\n      loadOptions: [\n        { name: \"Center To Center\", value: 0 },\n        { name: \"Origin To Origin\", value: 1 },\n        { name: \"Share Coordinates\", value: 2 },\n      ],\n\n      displayNeedToLoadModel: false,\n      modelLoaded: false,\n      selection: { nb: 0 },\n      models: {},\n      useAllModels: true,\n\n      mModels: [],\n      modelPosition: {},\n      autoLoad: false,\n      selectedModels: [],\n      bimFilesComputed: [],\n      step: 1,\n      scene: null,\n      bimFiles: [],\n\n      sceneName: \"\",\n      sceneDescr: \"\",\n\n      associatedModel: [],\n      attributesName: [],\n      isBimFileSelectorOpen: false,\n      modifyModelItem: false,\n      modelNeedToBeLoad: false,\n      currentModel: null,\n\n      attributeName: \"\",\n      attributeVal: \"\",\n      container: null,\n      numberProps: 0,\n      modelProps: {},\n    };\n  },\n  watch: {\n    selectedModel: function (value) {\n      for (let i = 0; i < value.length; i++) {\n        if (\n          typeof this.modelLoaded[value[i]] !== \"undefined\" &&\n          this.modelLoaded[value[i]]\n        )\n          continue;\n        for (let j = 0; j < this.bimFiles.length; j++) {\n          if (this.bimFiles[j].name.get() === value[i]) {\n            this.currentBimFile = this.bimFiles[j];\n            this.loadModel().then(() => {\n              this.modelLoaded[value[i]] = true;\n            });\n          }\n        }\n      }\n    },\n    // autoPosition: {\n    //   handler: function (value) {\n    //     if (value && !this.modelLoaded)\n    //       this.loadAllModel().then(() => {\n    //         console.log(\n    //           \"ok\",\n    //           this.mModels,\n    //           typeof this.mModels,\n    //           this.mModels.length\n    //         );\n    //         for (let i = 0; i < this.mModels.length; i++) {\n    //           let meta = this.mModels[i];\n    //           console.log(\"adasdasd\", meta);\n    //           this.modelPosition[meta.model.id] = {\n    //             globalOffset: meta.model.getData().globalOffset,\n    //           };\n    //         }\n    //       });\n    //   },\n    //   immediate: true,\n    // },\n  },\n  computed: {\n    name: function () {\n      if (this.scene !== null) return this.scene.name.get();\n      return \"\";\n    },\n    description: function () {\n      if (this.scene !== null) return this.scene.description.get();\n\n      return \"\";\n    },\n    nbModel: function () {\n      return this.selectedModels.length;\n    },\n    selectedModelInfo: function () {\n      //if here to be trigger when selection change\n      if (this.selection.nb !== 0)\n        return this.selectedModels.map((m) => this.getModelInfo(m));\n      else return this.selectedModels.map((m) => this.getModelInfo(m));\n    },\n    objectSelectedSentence: function () {\n      if (this.selection.nb <= 1) return `${this.selection.nb} object selected`;\n      return `${this.selection.nb} objects selected`;\n    },\n  },\n  methods: {\n    initialize: function (option) {\n      this.container = this.$el;\n      this.selection.nb = 0;\n      this.step1Container = document.getElementById(\"step1\");\n      this.step2Container = document.getElementById(\"step2\");\n      this.step3Container = document.getElementById(\"step3\");\n      this.bimFiles = option.bimFiles;\n      this.scene = option.scene;\n\n      this.bimFilesComputed = this.bimFiles.map((bimfile) => {\n        return bimfile.name.get();\n      });\n\n      this.useAllModels =\n        typeof this.scene.useAllModels !== \"undefined\"\n          ? this.scene.useAllModels.get()\n          : false;\n      this.loadOptionSelected =\n        typeof this.scene.sceneAlignMethod !== \"undefined\"\n          ? this.scene.sceneAlignMethod.get()\n          : 0;\n      this.autoLoad = this.scene.autoLoad.get();\n      if (typeof this.scene.option !== \"undefined\") {\n        for (let i = 0; i < this.scene.options; i++) {\n          this.selection.nb += this.scene.options[i].dbIds.get().length;\n        }\n      }\n      SceneHelper.getBimFilesFromScene(this.scene.id.get()).then((bimFiles) => {\n        this.selectedModels = bimFiles.map((bimFile) => bimFile.name.get());\n      });\n    },\n    getDbIdLength: function (model) {\n      if (typeof model !== \"undefined\" && typeof model.dbIds !== \"undefined\")\n        return model.dbIds.length;\n      return 0;\n    },\n    openBimFileSelector: function () {},\n    opened: function (option) {\n      this.initialize(option);\n    },\n    removed: function () {},\n    closeDialog: function (closeResult) {},\n    addModelToScene: function (bimFile) {\n      SceneHelper.addModelToScene(this.scene.id.get(), bimFile.id.get()).then(\n        () => {\n          this.associatedModel.push(bimFile);\n        }\n      );\n    },\n    getModelInfo(m) {\n      const info = {\n        name: \"\",\n        dbIds: [],\n      };\n      info[\"name\"] = m;\n\n      const model = window.spinal.BimObjectService.getModelByName(m);\n      if (typeof model === \"undefined\") return info;\n\n      info[\"model\"] = model;\n      info[\"dbIds\"] = this.selection[model.id];\n      return info;\n    },\n    loadModel: function () {\n      return window.spinal.SpinalForgeViewer.loadBimFile(\n        this.currentBimFile\n      ).then((m) => {\n        this.currentModel = m.model;\n        this.modelNeedToBeLoad = false;\n        return true;\n      });\n    },\n\n    loadAllModel() {\n      const proms = [];\n      for (let i = 0; i < this.bimFiles.length; i++) {\n        proms.push(\n          window.spinal.SpinalForgeViewer.loadBimFile(this.bimFiles[i])\n        );\n      }\n      return Promise.all(proms).then((res) => {\n        this.mModels = res;\n        console.log(res);\n        this.displayNeedToLoadModel = false;\n        this.modelLoaded = true;\n      });\n    },\n    selectOBJ: function () {\n      if (Object.keys(this.selection).length === 1 && !this.modelLoaded)\n        this.displayNeedToLoadModel = true;\n      spinal.ForgeViewer.viewer.clearSelection();\n      for (let key in this.selection) {\n        if (this.selection.hasOwnProperty(key) && key !== \"nb\") {\n          console.log(key);\n          console.log(this.models[key]);\n\n          this.models[key].selector.setSelection(\n            this.selection[key],\n            Autodesk.Viewing.SelectionMode\n          );\n          // window.spinal.ForgeViewer.viewerManager.select(\n          // this.selection[key], this.models[key] )\n        }\n      }\n    },\n    getSelection: function () {\n      const selection =\n        window.spinal.ForgeViewer.viewer.getAggregateSelection();\n\n      for (let i = 0; i < selection.length; i++) {\n        if (selection[i].hasOwnProperty(\"model\")) {\n          let dbids = this.selection[selection[i].model.id];\n          if (typeof dbids === \"undefined\") dbids = [];\n\n          const newIds = selection[i].selection.filter((dbid) => {\n            return dbids.indexOf(dbid) === -1;\n          });\n\n          dbids.push(...newIds);\n          this.selection[selection[i].model.id] = dbids;\n          this.models[selection[i].model.id] = selection[i].model;\n        }\n      }\n      let res = 0;\n      for (let key in this.selection) {\n        if (this.selection.hasOwnProperty(key) && key !== \"nb\") {\n          res += this.selection[key].length;\n        }\n      }\n      this.selection[\"nb\"] = res;\n    },\n    clearSelection: function () {\n      this.selection = { nb: 0 };\n    },\n    save: function () {\n      const info = {};\n      info[\"autoLoad\"] = this.autoLoad;\n      if (this.sceneDescr !== \"\") info[\"description\"] = this.sceneDescr;\n      if (this.sceneName !== \"\") info[\"name\"] = this.sceneName;\n      info[\"useAllDT\"] = this.useAllModels;\n      info[\"sceneAlignMethod\"] = this.loadOptionSelected;\n      info[\"options\"] = []; // [{urn: \"\", dbIds: []}]\n      for (let i = 0; i < this.selectedModels.length; i++) {\n        const modelName = this.selectedModels[i];\n        let model = window.spinal.BimObjectService.getModelByName(modelName);\n        if (typeof model !== \"undefined\") {\n          info[\"options\"].push({\n            urn: model.myData.urn,\n            dbIds: this.selection[model.id],\n            loadOption: this.modelPosition[model.id],\n          });\n        }\n      }\n      SpinalGraphService.getChildren(this.scene.id.get(), [\n        PART_RELATION_NAME,\n      ]).then((children) => {\n        const nodeToRemove = [];\n        const nodeToAdd = [];\n\n        if (typeof children !== \"undefined\") {\n          for (let i = 0; i < children.length; i++) {\n            if (this.selectedModels.indexOf(children[i].name.get()) === -1)\n              nodeToRemove.push(\n                SpinalGraphService.removeChild(\n                  this.scene.id.get(),\n                  children[i].id.get(),\n                  PART_RELATION_NAME,\n                  PART_RELATION_TYPE\n                )\n              );\n          }\n\n          for (let i = 0; i < this.selectedModels.length; i++) {\n            const node = children.find((child) => {\n              return child.name.get() === this.selectedModels[i];\n            });\n\n            const bimFile = this.bimFiles.find((file) => {\n              return file.name.get() === this.selectedModels[i];\n            });\n\n            if (typeof node === \"undefined\" && typeof bimFile !== \"undefined\")\n              nodeToAdd.push(\n                SceneHelper.addModelToScene(\n                  this.scene.id.get(),\n                  bimFile.id.get()\n                )\n              );\n          }\n        } else {\n          for (let i = 0; i < this.selectedModels.length; i++) {\n            const bimFile = this.bimFiles.filter((file) => {\n              return file.name.get() === this.selectedModels[i];\n            });\n\n            nodeToAdd.push(\n              SceneHelper.addModelToScene(this.scene.id.get(), bimFile.id.get())\n            );\n          }\n        }\n        Promise.all(nodeToRemove).then(() => {\n          Promise.all(nodeToAdd).then(() => {\n            SpinalGraphService.modifyNode(this.scene.id.get(), info);\n          });\n        });\n      });\n    },\n  },\n};\n</script>\n\n<style scoped>\n.scene-manager {\n  overflow: hidden;\n}\n\n.application--wrap * {\n}\n\n.scene-manager-vue {\n  height: calc(100% - 20px);\n  width: 100%;\n  overflow: hidden;\n}\n\n.scene-manager-vue * {\n  box-sizing: border-box;\n  -webkit-box-sizing: border-box;\n}\n\n.associated-model {\n  padding: 10px;\n  margin: 10px;\n  border: 1px solid rgba(128, 128, 128, 0.7);\n}\n\n.associated-model-item {\n  text-align: start;\n  border: 1px solid rgba(128, 128, 128, 0.64);\n  margin: 8px;\n  padding: 4px;\n  display: flex;\n  align-items: center;\n  align-content: center;\n}\n\n.open-bim-file-selector-fab {\n  position: absolute;\n  bottom: 10px;\n  right: 0px;\n}\n\n.bim-file-selector {\n  border: 1px solid rgba(128, 128, 128, 0.64);\n  margin: 10px;\n  position: relative;\n}\n\n.bim-file-selector-header {\n  display: flex;\n  justify-content: flex-end;\n}\n\n.bim-file-selector-item {\n  display: flex;\n  margin: 8px;\n  padding: 4px;\n  border: 1px solid rgba(128, 128, 128, 0.64);\n  align-content: center;\n  align-items: center;\n}\n\n.bim-file-selector-closer {\n}\n\n.bim-file-selector-body {\n  margin: 8px;\n}\n\nul {\n  list-style: none;\n  padding: unset;\n}\n\n.associated-model-item-name {\n  width: 80%;\n  text-overflow: ellipsis;\n  overflow: hidden;\n  margin: 0;\n}\n</style>"],"names":[],"version":3,"file":"spinal-env-viewer-plugin-scene.714efc65.css.map"}